<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Match - GridPlay</title>
    <link rel="stylesheet" href="memorymatch.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="../../index.html" class="back-btn">‚Üê Back</a>
            <a href="../../index.html" class="logo">GridPlay</a>
            <a href="../../account.html" class="account-btn">Account</a>
        </div>
    </header>

    <div class="game-container">
        <div class="game-header">
            <div class="game-title-section">
                <div class="game-icon-large">üß†</div>
                <div>
                    <h1>Memory Match</h1>
                    <p>Find all pairs before time runs out!</p>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-info">
                        <span class="stat-label">Level</span>
                        <span class="stat-value" id="level">1</span>
                    </div>
                </div>
                <div class="stat-card timer-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-info">
                        <span class="stat-label">Time Left</span>
                        <span class="stat-value" id="timer">3:00</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ú®</div>
                    <div class="stat-info">
                        <span class="stat-label">Pairs</span>
                        <span class="stat-value" id="pairs">0/8</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-area">
            <div class="level-indicator">
                <div class="level-dots">
                    <div class="level-dot active" data-level="1">1</div>
                    <div class="level-dot" data-level="2">2</div>
                    <div class="level-dot" data-level="3">3</div>
                    <div class="level-dot" data-level="4">4</div>
                    <div class="level-dot" data-level="5">5</div>
                </div>
            </div>

            <div class="cards-grid" id="cardsGrid">
                <!-- Cards will be generated by JavaScript -->
            </div>

            <div id="startBanner" class="start-banner">
                <div class="banner-content">
                    <h3>Ready to Start?</h3>
                    <p>Click Start to begin the timer</p>
                    <button id="startBtn" class="primary-btn">Start Game</button>
                </div>
            </div>

            <div class="game-controls">
                <button class="control-button" id="resetLevelBtn">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">Reset Level</span>
                </button>
                <button class="control-button" id="newGameBtn">
                    <span class="btn-icon">üéÆ</span>
                    <span class="btn-text">New Game</span>
                </button>
            </div>
        </div>

        <div id="levelCompleteOverlay" class="game-overlay hidden">
            <div class="overlay-content">
                <div class="level-icon">üéâ</div>
                <h2>Level Complete!</h2>
                <p class="level-stats">
                    Time remaining: <span id="timeBonus">0:30</span><br>
                    Moving to level <span id="nextLevel">2</span>
                </p>
                <button id="continueBtn" class="primary-btn">Continue</button>
            </div>
        </div>

        <div id="timeUpOverlay" class="game-overlay hidden">
            <div class="overlay-content">
                <div class="gameover-icon">‚è∞</div>
                <h2>Time's Up!</h2>
                <p class="gameover-stats">
                    You reached level <span id="finalLevel">1</span><br>
                    Best: Level <span id="bestLevel">1</span>
                </p>
                <button id="tryAgainBtn" class="primary-btn">Try Again</button>
            </div>
        </div>

        <div id="winOverlay" class="game-overlay hidden">
            <div class="overlay-content">
                <div class="win-icon">üèÜ</div>
                <h2>Victory!</h2>
                <p class="win-stats">
                    You completed all 5 levels!<br>
                    Congratulations, Memory Master!
                </p>
                <button id="playAgainBtn" class="primary-btn">Play Again</button>
            </div>
        </div>

        <div class="instructions-card">
            <div class="instructions-header">
                <h3>üéÆ How to Play</h3>
                <div class="best-record">
                    Best: Level <span id="recordLevel">0</span>
                </div>
            </div>
            <div class="instructions-list">
                <p>‚Ä¢ Click on cards to flip them over</p>
                <p>‚Ä¢ Find two matching cards</p>
                <p>‚Ä¢ Complete all pairs before time runs out</p>
                <p>‚Ä¢ Beat all 5 levels to become champion!</p>
                <p>‚Ä¢ Each level completed earns you XP</p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 GridPlay. All rights reserved.</p>
        <div class="footer-links">
            <a href="../../privacy.html">Privacy Policy</a>
            <a href="../../terms.html">Terms of Service</a>
            <a href="../../contact.html">Contact Us</a>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // ImportƒÉ Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            update, 
            push 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Configura»õie Firebase (folose»ôte aceea»ôi ca √Æn account.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAtPh9tyLEg4BBu2Pf-QY-vE3yzaHgSzXk",
            authDomain: "gridplay-5689a.firebaseapp.com",
            databaseURL: "https://gridplay-5689a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gridplay-5689a",
            storageBucket: "gridplay-5689a.firebasestorage.app",
            messagingSenderId: "822079861846",
            appId: "1:822079861846:web:93b9460ef8da963a31f7f7"
        };

        // Ini»õializeazƒÉ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Variabile globale
        window.currentUserId = null;
        window.isUserLoggedIn = false;

        // VerificƒÉ dacƒÉ utilizatorul este autentificat
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUserId = user.uid;
                window.isUserLoggedIn = true;
                loadHighScore();
            } else {
                window.isUserLoggedIn = false;
                window.currentUserId = null;
                // Folose»ôte high score-ul din localStorage
                const localBest = localStorage.getItem('memoryBestLevel') || 0;
                document.getElementById('recordLevel').textContent = localBest;
                document.getElementById('bestLevel').textContent = localBest;
            }
        });

        async function loadHighScore() {
            if (!window.currentUserId) return;
            
            try {
                const snapshot = await get(ref(database, `gameSessions/${window.currentUserId}/memory/highScore`));
                if (snapshot.exists()) {
                    const highScore = snapshot.val();
                    localStorage.setItem('memoryBestLevel', highScore);
                    document.getElementById('recordLevel').textContent = highScore;
                    document.getElementById('bestLevel').textContent = highScore;
                }
            } catch (error) {
                console.error("Error loading high score:", error);
            }
        }

        // Func»õie pentru a salva progresul jocului √Æn Firebase
        window.saveMemoryGameProgress = async function(levelReached, xpEarned, timePlayed) {
            if (!window.currentUserId || !window.isUserLoggedIn) {
                return 0; // Nu salva dacƒÉ nu e logat
            }

            try {
                const updates = {};
                const playTimeMinutes = Math.max(1, Math.floor(timePlayed / 60));
                
                // Ob»õine datele jucƒÉtorului
                const playerRef = ref(database, `playerStats/${window.currentUserId}`);
                const playerSnapshot = await get(playerRef);
                
                if (!playerSnapshot.exists()) return 0;
                
                const playerData = playerSnapshot.val();
                
                // Update high score
                const currentHighScore = await get(ref(database, `gameSessions/${window.currentUserId}/memory/highScore`));
                const highScoreValue = currentHighScore.exists() ? currentHighScore.val() : 0;
                
                if (levelReached > highScoreValue) {
                    updates[`gameSessions/${window.currentUserId}/memory/highScore`] = levelReached;
                    localStorage.setItem('memoryBestLevel', levelReached);
                }
                
                // Increment minutes played
                const currentMinutes = playerData.minutesPlayed || 0;
                updates[`playerStats/${window.currentUserId}/minutesPlayed`] = currentMinutes + playTimeMinutes;
                
                // Increment games completed (1 game per level completed)
                // De exemplu: level 3 = 3 games completed
                updates[`playerStats/${window.currentUserId}/gamesCompleted`] = (playerData.gamesCompleted || 0) + levelReached;
                
                // AdaugƒÉ XP
                const currentXp = playerData.currentXp || 0;
                updates[`playerStats/${window.currentUserId}/currentXp`] = currentXp + xpEarned;
                
                // VerificƒÉ level up
                let level = playerData.level || 1;
                let nextLevelXp = playerData.nextLevelXp || 500;
                let newXp = currentXp + xpEarned;
                
                if (newXp >= nextLevelXp) {
                    level += 1;
                    nextLevelXp = Math.floor(nextLevelXp * 1.5);
                    updates[`playerStats/${window.currentUserId}/level`] = level;
                    updates[`playerStats/${window.currentUserId}/nextLevelXp`] = nextLevelXp;
                }
                
                // SalveazƒÉ sesiunea
                const sessionData = {
                    levelReached: levelReached,
                    xpEarned: xpEarned,
                    timePlayed: playTimeMinutes,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString()
                };
                
                await push(ref(database, `gameSessions/${window.currentUserId}/memory/sessions`), sessionData);
                
                // AplicƒÉ update-urile
                await update(ref(database), updates);
                
                console.log(`Memory Game saved! Level: ${levelReached}, XP: +${xpEarned}`);
                return xpEarned;
                
            } catch (error) {
                console.error("Error saving memory game:", error);
                return 0;
            }
        };
    </script>

    <script src="memorymatch.js"></script>
</body>
</html>