<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Puzzle - GridPlay</title>
    <link rel="stylesheet" href="numberpuzzle.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="../../index.html" class="back-btn">‚Üê Back</a>
            <a href="../../index.html" class="logo">GridPlay</a>
            <a href="../../account.html" class="account-btn">Account</a>
        </div>
    </header>

    <div class="game-container">
        <div class="game-header">
            <div class="game-title-section">
                <div class="game-icon-large">üî¢</div>
                <div>
                    <h1>Number Puzzle</h1>
                    <p>Slide tiles into the empty space!</p>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon">üë£</div>
                    <div class="stat-info">
                        <span class="stat-label">Moves</span>
                        <span class="stat-value" id="moves">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-info">
                        <span class="stat-label">Time</span>
                        <span class="stat-value" id="timer">0:00</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-info">
                        <span class="stat-label">Best</span>
                        <span class="stat-value" id="bestMoves">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-area">
            <div class="difficulty-selector">
                <button class="diff-btn" data-size="3">3x3</button>
                <button class="diff-btn active" data-size="4">4x4</button>
                <button class="diff-btn" data-size="5">5x5</button>
            </div>

            <div class="puzzle-wrapper">
                <div class="puzzle-board" id="board">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div id="startBanner" class="start-banner">
                <div class="banner-content">
                    <h3>Ready?</h3>
                    <p>Drag tiles into empty space</p>
                    <button id="startBtn" class="primary-btn">Start</button>
                </div>
            </div>

            <div class="game-controls">
                <button class="control-button" id="shuffleBtn">
                    <span class="btn-icon">üîÄ</span>
                    <span class="btn-text">Shuffle</span>
                </button>
                <button class="control-button" id="resetBtn">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">Reset</span>
                </button>
            </div>
        </div>

        <div id="winOverlay" class="game-overlay hidden">
            <div class="overlay-content">
                <div class="win-icon">üéâ</div>
                <h2>Solved!</h2>
                <p class="win-stats">
                    Moves: <span id="finalMoves">0</span><br>
                    Time: <span id="finalTime">0:00</span>
                    <span id="newRecord" class="new-record hidden">üèÜ New Record!</span>
                </p>
                <p id="xpEarnedText" class="xp-earned hidden"></p>
                <button id="playAgainBtn" class="primary-btn">Play Again</button>
            </div>
        </div>

        <div class="instructions-card">
            <h3>üéÆ How to Play</h3>
            <div class="instructions-list">
                <p>‚Ä¢ Drag tiles next to the empty space to move them</p>
                <p>‚Ä¢ Tiles can only move INTO the empty space</p>
                <p>‚Ä¢ Arrange numbers in order: 1, 2, 3, etc.</p>
                <p>‚Ä¢ Try to solve with minimum moves!</p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 GridPlay. All rights reserved.</p>
        <div class="footer-links">
            <a href="../../privacy.html">Privacy Policy</a>
            <a href="../../terms.html">Terms of Service</a>
            <a href="../../contact.html">Contact Us</a>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // ImportƒÉ Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            update, 
            push 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Configura»õie Firebase (folose»ôte aceea»ôi ca √Æn account.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAtPh9tyLEg4BBu2Pf-QY-vE3yzaHgSzXk",
            authDomain: "gridplay-5689a.firebaseapp.com",
            databaseURL: "https://gridplay-5689a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gridplay-5689a",
            storageBucket: "gridplay-5689a.firebasestorage.app",
            messagingSenderId: "822079861846",
            appId: "1:822079861846:web:93b9460ef8da963a31f7f7"
        };

        // Ini»õializeazƒÉ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Variabile globale
        window.currentUserId = null;
        window.isUserLoggedIn = false;

        // VerificƒÉ dacƒÉ utilizatorul este autentificat
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUserId = user.uid;
                window.isUserLoggedIn = true;
                loadRecords();
            } else {
                window.isUserLoggedIn = false;
                window.currentUserId = null;
                // Folose»ôte recordurile din localStorage
                const localRecords = {
                    3: parseInt(localStorage.getItem('puzzle3x3')) || null,
                    4: parseInt(localStorage.getItem('puzzle4x4')) || null,
                    5: parseInt(localStorage.getItem('puzzle5x5')) || null
                };
                updateBestMovesUI(localRecords);
            }
        });

        async function loadRecords() {
            if (!window.currentUserId) return;
            
            try {
                const snapshot = await get(ref(database, `gameSessions/${window.currentUserId}/puzzle/records`));
                if (snapshot.exists()) {
                    const firebaseRecords = snapshot.val();
                    
                    // ActualizeazƒÉ localStorage cu datele din Firebase
                    if (firebaseRecords["3"]) localStorage.setItem('puzzle3x3', firebaseRecords["3"]);
                    if (firebaseRecords["4"]) localStorage.setItem('puzzle4x4', firebaseRecords["4"]);
                    if (firebaseRecords["5"]) localStorage.setItem('puzzle5x5', firebaseRecords["5"]);
                    
                    updateBestMovesUI(firebaseRecords);
                }
            } catch (error) {
                console.error("Error loading puzzle records:", error);
            }
        }

        // Func»õie pentru a salva progresul √Æn Firebase
        window.savePuzzleProgress = async function(puzzleSize, moves, timeSeconds, xpEarned) {
            if (!window.currentUserId || !window.isUserLoggedIn) {
                return 0; // Nu salva dacƒÉ nu e logat
            }

            try {
                const updates = {};
                const playTimeMinutes = Math.max(1, Math.floor(timeSeconds / 60));
                
                // Ob»õine datele jucƒÉtorului
                const playerRef = ref(database, `playerStats/${window.currentUserId}`);
                const playerSnapshot = await get(playerRef);
                
                if (!playerSnapshot.exists()) return 0;
                
                const playerData = playerSnapshot.val();
                
                // Update record pentru puzzle size-ul curent
                const currentRecord = await get(ref(database, `gameSessions/${window.currentUserId}/puzzle/records/${puzzleSize}`));
                const recordValue = currentRecord.exists() ? currentRecord.val() : null;
                
                if (recordValue === null || moves < recordValue) {
                    updates[`gameSessions/${window.currentUserId}/puzzle/records/${puzzleSize}`] = moves;
                    localStorage.setItem(`puzzle${puzzleSize}x${puzzleSize}`, moves);
                }
                
                // Increment minutes played
                const currentMinutes = playerData.minutesPlayed || 0;
                updates[`playerStats/${window.currentUserId}/minutesPlayed`] = currentMinutes + playTimeMinutes;
                
                // Increment games completed (1 puzzle solved = 1 game completed)
                updates[`playerStats/${window.currentUserId}/gamesCompleted`] = (playerData.gamesCompleted || 0) + 1;
                
                // AdaugƒÉ XP
                const currentXp = playerData.currentXp || 0;
                updates[`playerStats/${window.currentUserId}/currentXp`] = currentXp + xpEarned;
                
                // VerificƒÉ level up
                let level = playerData.level || 1;
                let nextLevelXp = playerData.nextLevelXp || 500;
                let newXp = currentXp + xpEarned;
                
                if (newXp >= nextLevelXp) {
                    level += 1;
                    nextLevelXp = Math.floor(nextLevelXp * 1.5);
                    updates[`playerStats/${window.currentUserId}/level`] = level;
                    updates[`playerStats/${window.currentUserId}/nextLevelXp`] = nextLevelXp;
                }
                
                // SalveazƒÉ sesiunea
                const sessionData = {
                    puzzleSize: puzzleSize,
                    moves: moves,
                    time: playTimeMinutes,
                    xpEarned: xpEarned,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString()
                };
                
                await push(ref(database, `gameSessions/${window.currentUserId}/puzzle/sessions`), sessionData);
                
                // AplicƒÉ update-urile
                await update(ref(database), updates);
                
                console.log(`Puzzle saved! Size: ${puzzleSize}x${puzzleSize}, Moves: ${moves}, XP: +${xpEarned}`);
                return xpEarned;
                
            } catch (error) {
                console.error("Error saving puzzle:", error);
                return 0;
            }
        };

        // Func»õie pentru a actualiza UI-ul cu recordurile
        function updateBestMovesUI(records) {
            // AceastƒÉ func»õie va fi apelatƒÉ din numberpuzzle.js
            if (window.updatePuzzleRecords) {
                window.updatePuzzleRecords(records);
            }
        }

        // Expune func»õii globale
        window.getCurrentUserId = () => window.currentUserId;
        window.getIsUserLoggedIn = () => window.isUserLoggedIn;

    </script>

    <script src="numberpuzzle.js"></script>
</body>
</html>